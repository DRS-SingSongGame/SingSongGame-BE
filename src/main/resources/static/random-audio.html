<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ğŸ® ê²Œì„ í…ŒìŠ¤íŠ¸ í˜ì´ì§€</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 20px; }
        .container { max-width: 600px; margin: auto; }
        .input-group { margin-bottom: 10px; }
        #messages { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; margin-bottom: 10px; }
        .message { margin-bottom: 5px; }
        .message.system { font-style: italic; color: #888; }
        .message.correct { font-weight: bold; color: green; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ® ê²Œì„ í…ŒìŠ¤íŠ¸ í˜ì´ì§€</h2>

    <div class="input-group">
        <label for="room-id">ë°© ID: </label>
        <input type="text" id="room-id" value="1">
        <button onclick="connect()">ğŸ”— ì—°ê²°</button>
        <button onclick="disconnect()" disabled>âŒ ì—°ê²° ëŠê¸°</button>
    </div>

    <hr>

    <h3>ë°© ìƒì„±</h3>
    <div class="input-group">
        <label for="create-room-name">ë°© ì´ë¦„: </label>
        <input type="text" id="create-room-name" value="ìƒˆë¡œìš´ ë°©">
    </div>
    <div class="input-group">
        <label for="create-room-type">ë°© íƒ€ì…: </label>
        <select id="create-room-type">
            <option value="RANDOM_SONG">RANDOM_SONG</option>
            <option value="PLAIN_SONG">PLAIN_SONG</option>
            <option value="KEY_SING_YOU">KEY_SING_YOU</option>
        </select>
    </div>
    <div class="input-group">
        <label for="create-room-private">ë¹„ê³µê°œ: </label>
        <input type="checkbox" id="create-room-private">
    </div>
    <div class="input-group">
        <label for="create-room-password">ë¹„ë°€ë²ˆí˜¸ (ì„ íƒ): </label>
        <input type="number" id="create-room-password">
    </div>
    <div class="input-group">
        <label for="create-room-max-player">ìµœëŒ€ ì¸ì›: </label>
        <input type="number" id="create-room-max-player" value="4" min="2" max="8">
    </div>
    <button onclick="createRoom()">â• ë°© ìƒì„±</button>

    <div class="input-group">
        <button id="start-game-btn" onclick="startGame()" disabled>ğŸš€ ê²Œì„ ì‹œì‘</button>
    </div>

    <hr>

    <div id="game-area" style="display: none;">
        <h3>ğŸ“¢ ê³µì§€</h3>
        <div id="notice"></div>
        
        <h3>ğŸµ í˜„ì¬ ê³¡ ì •ë³´</h3>
        <p id="song-info">ëŒ€ê¸° ì¤‘...</p>
        <audio id="audio-player" controls></audio>

        <h3>ğŸ’¬ ì±„íŒ… ë° ì •ë‹µ ì…ë ¥</h3>
        <div id="messages"></div>
        <div class="input-group">
            <input type="text" id="chat-input" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”..." onkeyup="if(event.keyCode===13)sendAnswer();">
            <button onclick="sendAnswer()">ì „ì†¡</button>
        </div>
    </div>
</div>

<script>
    let stompClient = null;
    let roomId = null;

    function connect() {
        roomId = document.getElementById('room-id').value;
        if (!roomId) {
            alert("ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        const socket = new SockJS('/api/ws/chat'); // WebSocket í•¸ë“œì…°ì´í¬ ì—”ë“œí¬ì¸íŠ¸
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            setConnected(true);

            // ê²Œì„ ì‹œì‘ ê³µì§€ êµ¬ë…
            stompClient.subscribe('/topic/room/' + roomId + '/game-start', function (response) {
                const body = JSON.parse(response.body);
                displayNotice(`ê²Œì„ì´ ${body.countdownSeconds}ì´ˆ í›„ì— ì‹œì‘ë©ë‹ˆë‹¤!`);
            });

            // ë‹¤ìŒ ë¼ìš´ë“œ ì •ë³´ êµ¬ë…
            stompClient.subscribe('/topic/room/' + roomId + '/round-start', function (response) {
                const body = JSON.parse(response.body);
                displayRoundInfo(body);
            });
            
            // ì •ë‹µ ê²°ê³¼ êµ¬ë…
            stompClient.subscribe('/topic/room/' + roomId + '/answer', function (response) {
                const body = JSON.parse(response.body);
                displayMessage(`${body.username}ë‹˜ì´ ì •ë‹µì„ ë§ì·„ìŠµë‹ˆë‹¤! (ì •ë‹µ: ${body.correctAnswer})`, 'correct');
            });

            // ì¼ë°˜ ì±„íŒ… ë©”ì‹œì§€ êµ¬ë… (ëŒ€ê¸°ì‹¤ìš©)
            stompClient.subscribe('/topic/room/' + roomId, function (response) {
                const body = JSON.parse(response.body);
                displayMessage(`${body.senderName}: ${body.message}`);
            });

        }, function(error) {
            console.error('STOMP error', error);
            alert('ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
        setConnected(false);
        console.log("Disconnected");
    }

    function setConnected(connected) {
        document.getElementById('start-game-btn').disabled = !connected;
        document.querySelector('button[onclick="connect()"]').disabled = connected;
        document.querySelector('button[onclick="disconnect()"]').disabled = !connected;
        document.getElementById('game-area').style.display = connected ? 'block' : 'none';
    }

    async function startGame() {
        try {
            const response = await fetch(`/api/in-game/${roomId}/start`, { method: 'POST' });
            if (!response.ok) {
                throw new Error('ê²Œì„ ì‹œì‘ ìš”ì²­ ì‹¤íŒ¨');
            }
            console.log("ê²Œì„ ì‹œì‘ ìš”ì²­ ì„±ê³µ");
            displayNotice("ê²Œì„ ì‹œì‘ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤. ì¹´ìš´íŠ¸ë‹¤ìš´ì„ ê¸°ë‹¤ë¦¬ì„¸ìš”...");
        } catch (error) {
            console.error('Error starting game:', error);
            alert('ê²Œì„ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    function sendAnswer() {
        const chatInput = document.getElementById('chat-input');
        const message = chatInput.value;
        if (message && stompClient) {
            // ê²Œì„ ì¤‘ ì±„íŒ…ì€ ì •ë‹µ í™•ì¸ìš© ì—”ë“œí¬ì¸íŠ¸ë¡œ ì „ì†¡
            stompClient.send(`/api/app/in-game/${roomId}/chat`, {}, JSON.stringify({'message': message}));
            
            // ëŒ€ê¸°ì‹¤ ì±„íŒ…ì€ ë³„ë„ ì—”ë“œí¬ì¸íŠ¸ë¡œ ì „ì†¡ (í•„ìš”ì‹œ í™œì„±í™”)
            stompClient.send(`/app/room/${roomId}/chat`, {}, JSON.stringify({'message': message}));

            chatInput.value = '';
        }
    }
    
    function displayNotice(message) {
        document.getElementById('notice').innerHTML = message;
    }

    function displayRoundInfo(roundData) {
        // TODO: ì„œë²„ì—ì„œ ë‚´ë ¤ì£¼ëŠ” ì‹¤ì œ ë°ì´í„° êµ¬ì¡°ì— ë§ê²Œ ìˆ˜ì • í•„ìš”
        // ì˜ˆì‹œ: roundData = { audioUrl: '...', hint: '...' }
        const songInfo = document.getElementById('song-info');
        const audioPlayer = document.getElementById('audio-player');
        
        songInfo.innerText = `íŒíŠ¸: ${roundData.hint || 'ì—†ìŒ'}`;
        audioPlayer.src = roundData.audioUrl;
        audioPlayer.load();
        audioPlayer.play();
        
        displayMessage(`ìƒˆ ë¼ìš´ë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'system');
    }

    function displayMessage(message, type = 'normal') {
        const messagesDiv = document.getElementById('messages');
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', type);
        messageElement.textContent = message;
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight; // ìë™ ìŠ¤í¬ë¡¤
    }

    async function createRoom() {
        const name = document.getElementById('create-room-name').value;
        const roomType = document.getElementById('create-room-type').value;
        const isPrivate = document.getElementById('create-room-private').checked;
        const roomPassword = document.getElementById('create-room-password').value;
        const maxPlayer = document.getElementById('create-room-max-player').value;

        const requestBody = {
            name: name,
            roomType: roomType,
            isPrivate: isPrivate,
            maxPlayer: parseInt(maxPlayer)
        };

        if (isPrivate && roomPassword) {
            requestBody.roomPassword = parseInt(roomPassword);
        }

        try {
            const response = await fetch('/api/room', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'ë°© ìƒì„± ì‹¤íŒ¨');
            }

            const responseData = await response.json();
            const createdRoomId = responseData.data.roomId;
            document.getElementById('room-id').value = createdRoomId;
            alert(`ë°©ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ë°© ID: ${createdRoomId}`);
            connect(); // ë°© ìƒì„± í›„ ë°”ë¡œ ì—°ê²°
        } catch (error) {
            console.error('Error creating room:', error);
            alert(`ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
        }
    }

</script>
</body>
</html>
